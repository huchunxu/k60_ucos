/*
 * =====================================================================================
 *        COPYRIGHT NOTICE
 *        Copyright (c) 2012  HUST-Renesas Lab
 *        ALL rights reserved.
 *//**        
 *        @file     start.S
 *
 *        @brief    starup file
 *
 *        @version  0.1
 *        @date     2012/3/9 14:05:09
 *
 *        @author   Ren Wei , renweihust@gmail.com
 *//* ==================================================================================
 *	@0.1 	Ren Wei	2012/3/9	create orignal file
 * =====================================================================================
 */

    .section .vector, "a"
    .global init_vector
    .code 16
    .syntax unified
 init_vector:
    .word   __onchip_ram_end,system_start
    .word   0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0 
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0 
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0 
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0 
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
    .word   0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0   
    .word   0xFFFFFFFF,0xFFFFFFFF,0xFFFFFFFF,0xFFFFFFFE
    
    .text
    .global system_start
	.code 16
	.syntax unified
	.type system_start, function
system_start:
	cpsid f   /* disable all exceptions */

	mov     r0,#0
	mov     r1,#0
	mov     r2,#0
	mov     r3,#0
	mov     r4,#0
	mov     r5,#0
	mov     r6,#0
	mov     r7,#0
	mov     r8,#0
	mov     r9,#0
	mov     r10,#0
	mov     r11,#0
	mov     r12,#0

    /*
	 *  msp setting
     */
	mov r0, #0
	msr control, r0
	isb

	/*
     * set default stack pointer
     */
	ldr r0, =__onchip_ram_end
	msr msp, r0

	ldr r0, =hardware_init_hook
    cbz r0, init_phase1
	blx r0

init_phase1:
	/*
     * set application stack pointer
     */
	ldr r0, =p_system_stack
	ldr r1, [r0]
	msr msp, r1

	/*
     * clear bss section
     */
start_1:
	mov  r0, #0
	ldr  r1, =__bss_start
	ldr  r2, =__bss_end
	cmp  r1, r2
	bhs  start_3
start_2:
	str  r0, [r1]
	add  r1,r1, #4
	cmp  r1, r2
	blo  start_2

	/*
     * clear data section
     */
start_3:
	ldr  r1, =__idata_start
	ldr  r2, =__idata_end
	cmp  r1, r2
	bhs  start_kernel
	ldr  r3, =__data_start
start_4:
	ldr  r0, [r1]
	str  r0, [r3]
	add  r1, #4
	add  r3, #4
	cmp  r1, r2
	blo  start_4

start_kernel:
    b main
